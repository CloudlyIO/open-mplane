#!/bin/sh 

action="${1:-start}"

##----------------------------------------------------------------------------------------------------------------------
# Constants
##----------------------------------------------------------------------------------------------------------------------
USERLIST=/nandflash/.settings/users

##----------------------------------------------------------------------------------------------------------------------
# handle error
##----------------------------------------------------------------------------------------------------------------------
errorMsg()
{
    echo >&2 "******* $@ *******"
}

##----------------------------------------------------------------------------------------------------------------------
# log a message
##----------------------------------------------------------------------------------------------------------------------
logMsg()
{
	msg="[$(date +%T)]: $*"
	echo "$msg"
}


##----------------------------------------------------------------------------------------------------------------------
# Read user list file if present
##----------------------------------------------------------------------------------------------------------------------


##----------------------------------------------------------------------------------------------------------------------
# start()
##----------------------------------------------------------------------------------------------------------------------
start()
{
	# Read user list file if present
	if [ -f $USERLIST ]; then
	
		while IFS= read line
		do
			if [ -z "$line" ]; then
				continue
			fi
			if [[ "$line" == "#"* ]]; then
				continue
			fi

			IFS=':' read -a strarr <<< "$line"

			user=${strarr[0]}
			group=${strarr[1]}
			passwd=${strarr[2]}
			home=${strarr[3]}
			
			logMsg Creating $user:$group home directory $home
				
			if grep -q $user: /etc/passwd; then                                                                              
				userdel $user                 
			fi                                                                                                                      
			if grep -q $group: /etc/group; then
				groupdel $group          
			fi                                                                                                                      
			rm -rf $home>/dev/null 2>&1   
			                                                                                                          
			groupadd $group                                                                                                   
			useradd -g $group -p $(openssl passwd $passwd) -m -d $home $user                               
			
		done < "$USERLIST"
	fi
}

##----------------------------------------------------------------------------------------------------------------------
# stop()
##----------------------------------------------------------------------------------------------------------------------
stop()
{
	:
}


##=== MAIN =============================================================================================================

case $action in
    start)
		start
	;;
    stop)
    	stop
	;;
    restart)
    	stop
    	sleep 1
		start
	;;
    *)
    	echo >&2 "$0 - '$1' invalid action"
	exit 2
	;;
esac



